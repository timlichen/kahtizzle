<!DOCTYPE html>
<html lang="en" ng-app='myApp'>
<head>
  <meta charset="UTF-8">
  <title>Index Page</title>
  <script type="text/javascript" src="js/lib/angular.js"></script>
  <script type="text/javascript" src="js/lib/angular-route.js"></script>

  <script type="text/javascript">
    var myAppObject  = angular.module('myApp', ['ngRoute'])

    //Angular Partial Routes
    myAppObject.config(function($routeProvider){
      $routeProvider
      .when('/', {
        redirectTo: '/login'
      })
      .when('/login', {
        templateUrl: 'partials/login.partial.html',
        controller: 'SessionsController',
        controllerAs: 'sessionsCtrl'
      })
      .when('/registration', {
        templateUrl: 'partials/registration.partial.html',
        controller: 'UsersController',
        controllerAs: 'usersCtrl'
      })
      .when('/dashboard', {
        templateUrl: 'partials/dashboard.partial.html',
        controller: 'DashboardsController',
        controllerAs: 'dashboardCtrl'
      })
      .otherwise({
        redirectTo: '/'
      })
    })

    myAppObject.controller('DashboardsController', function(SessionFactory){
      var _this = this;
      var available_tiles = {
        sheep:  4,
        wheat:  4,
        wood:   4,
        brick:  3,
        ore:    3,
        desert: 1,
      };
      var total_tiles = 19;

      // List of possible rolls and their probability and piece count
      var circle_options = {
        '2':  {prob: 1, count: 1},
        '3':  {prob: 2, count: 2},
        '4':  {prob: 3, count: 2},
        '5':  {prob: 4, count: 2},
        '6':  {prob: 5, count: 2},
        '8':  {prob: 5, count: 2},
        '9':  {prob: 4, count: 2},
        '10': {prob: 3, count: 2},
        '11': {prob: 2, count: 2},
        '12': {prob: 1, count: 1}
      };

      // Make array of all available circle roll options (ex: [2,3,3,4,4,...,12])
      var rolls = [];
      for (var opt in circle_options) {
        for (var i = 0; i < circle_options[opt].count; i++) {
          rolls.push(opt);
        }
      }

      function makeAllHexes () {
        // Available tile ids
        var avail = [];
        // Make array of all available ids (ex: [1,2,3,...,19])
        for (var t = 1; t <= total_tiles; t++) {
          avail.push(t);
        }
        // Go through all tiles by type
        for (var tile_type in available_tiles) {
          for (var i = 0; i < available_tiles[tile_type]; i++) {
            // Get random available id
            var pos = Math.floor((Math.random() * (avail.length - 1)));
            var temp = avail[pos];
            avail[pos] = avail[avail.length - 1];
            avail[avail.length - 1] = temp;
            avail.pop();
            // Assign tile type and id to new hex
            makeHex(tile_type, temp);
          }
        }
      }

      function makeHex (tile_type, id) {
        hex = {hex_id: id, tile_type: tile_type, circle: tile_type !== 'desert' && makeCircle()};
        _this.allhexes.push(hex);
      }

      // Creates central circle with roll number, chance, dots, etc.
      function makeCircle () {
        var pos = Math.floor((Math.random() * (rolls.length - 1)));
        var roll = rolls[pos];
        rolls[pos] = rolls[rolls.length - 1];
        rolls[rolls.length - 1] = roll;
        rolls.pop();

        // Make the dots below the roll number
        var dotstring = '';
        for (var i = 0; i < circle_options[roll].prob; i++) {
          dotstring += '.';
        }

        return {
          roll: roll,
          color: (roll == 6 || roll == 8) ? 'red' : 'black',
          chance: Math.round((circle_options[roll].prob / 36) * 100),
          dots: dotstring
        };
      }

      // Create all the tiles needed for a starting board
      _this.allhexes = [];
      makeAllHexes();

      console.log('DashboardsController Loaded');

      // Commented out temporarily so you don't have to log in every time you refresh while testing
      // SessionFactory.authenticate();
    });

    myAppObject.controller('UsersController', function(UserFactory){
      var _this = this;
      console.log("UsersController Loaded...")
      this.create = function(newUser){
        _this.errors = {}; //CLEAN errors on each new call so old errors do no persist
        if(newUser){
          console.log('UsersController / creating', newUser);
          UserFactory.create(newUser, function(errors){ //MARK
            // console.log('Called back from UsersFactory Create');
            console.log('###', errors);
            //This ties it to the parent "this" instance allowing it to be displayed on the registration partial.
            _this.errors = errors;
          })
        }
      }
    });

    myAppObject.factory('UserFactory', function($http, $location){
      var factory = {
        create: function(newUser, callback){
          console.log('user', newUser);
          $http.post('/users', newUser).success(function(response){
            console.log("server responded post('/users')", response)
            if(response.errors){
              //this will return an object of objects, passing back to the controller callback function on line marked line
              callback(response.errors);

            } else {
              $location.path('/login');
              console.log('no errors')};
          })
        }
      }
      return factory;
    })

    myAppObject.controller('SessionsController', function(SessionFactory){
      console.log("SessionsController Loaded...")
      var _this = this;
      this.create = function(user){
      // CLEANING error
      // -- this causes an empty object when nothing is submitted --
      // _this.error = {};
        if(user){
          console.log('SessionsController / create', user);
          SessionFactory.create(user, function(user){
            if(user.error){
              _this.error = user.error
            }
            console.log('create back from factory');
          })
        }
      }
    });

    myAppObject.factory('SessionFactory', function($http, $location){
      var logged_in_user;
      var factory = {

      create: function(user, callback){
        console.log('user', user);
        $http.post('/sessions', user).success(function(response){
          if(response){
            logged_in_user = response;
            $location.path('/dashboard')
            callback(response);
          }else {
            callback({error: "Invalid Credentials"})
          }
        })
      },

      authenticate: function(){
          $http.get('/authenticate').success(function(response){
            if(!response){
              console.log('server says no');
              alert('You are logged out');
              $location.path('/login');
            }
          })
        }
      }

      return factory;
    })

  </script>
</head>
<body>
  <h1>Index</h1>
  <div ng-view></div>
</body>
</html>